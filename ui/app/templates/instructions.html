{% extends "base.html" %}

{% block title %}Instructions - Vextir Dashboard{% endblock %}
{% block page_title %}Instructions{% endblock %}

{% block extra_head %}
<style>
    .instruction-card {
        transition: all 0.3s ease;
    }
    .instruction-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }
    .trigger-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }
    .action-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }
    .json-editor {
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.875rem;
    }
    .modal {
        display: none !important;
    }
    .modal.show {
        display: flex !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header with Create Button -->
    <div class="flex justify-between items-center">
        <div>
            <h2 class="text-2xl font-bold text-gray-900">Automation Instructions</h2>
            <p class="text-gray-600 mt-1">Create automated workflows that respond to events and execute actions</p>
        </div>
        <button id="create-instruction-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center space-x-2">
            <i class="fas fa-plus"></i>
            <span>Create Instruction</span>
        </button>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <div class="bg-white p-6 rounded-lg shadow">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                    <i class="fas fa-cogs"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Total Instructions</p>
                    <p id="total-instructions" class="text-2xl font-semibold text-gray-900">-</p>
                </div>
            </div>
        </div>
        <div class="bg-white p-6 rounded-lg shadow">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-green-100 text-green-600">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Active</p>
                    <p id="active-instructions" class="text-2xl font-semibold text-gray-900">-</p>
                </div>
            </div>
        </div>
        <div class="bg-white p-6 rounded-lg shadow">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                    <i class="fas fa-play"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Total Executions</p>
                    <p id="total-executions" class="text-2xl font-semibold text-gray-900">-</p>
                </div>
            </div>
        </div>
        <div class="bg-white p-6 rounded-lg shadow">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Last Execution</p>
                    <p id="last-execution" class="text-sm font-semibold text-gray-900">-</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Instructions List -->
    <div class="bg-white rounded-lg shadow">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-medium text-gray-900">Your Instructions</h3>
        </div>
        <div id="instructions-container" class="p-6">
            <div class="text-center py-8">
                <i class="fas fa-spinner fa-spin text-gray-400 text-2xl"></i>
                <p class="text-gray-500 mt-2">Loading instructions...</p>
            </div>
        </div>
    </div>
</div>

<!-- Create/Edit Instruction Modal -->
<div id="instruction-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-3xl shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <!-- Modal Header -->
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-title" class="text-lg font-medium text-gray-900">Create New Instruction</h3>
                <button id="close-modal" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Natural Language Form -->
            <form id="instruction-form" class="space-y-6">
                <input type="hidden" id="instruction-id" name="instruction_id">
                
                <!-- Name Field -->
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700 mb-1">
                        Instruction Name
                    </label>
                    <input type="text" id="name" name="name" required
                           placeholder="e.g., Daily Summary Report, Project Status Monitor"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <!-- Natural Language Instruction -->
                <div>
                    <label for="instruction-text" class="block text-sm font-medium text-gray-700 mb-1">
                        What should this instruction do?
                    </label>
                    <textarea id="instruction-text" name="instruction_text" rows="4" required
                              placeholder="Describe in natural language what you want to happen. For example:&#10;&#10;'When I receive an email about a project update, extract the key information and update my project status summary'&#10;&#10;'Every morning at 9am, check my calendar and email me a summary of today's meetings'"
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                    <p class="mt-1 text-xs text-gray-500">
                        Be specific about triggers (when/what events) and actions (what to do)
                    </p>
                </div>
                
                <!-- Available Events Reference -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <h4 class="text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-info-circle mr-1"></i>
                        Available Event Triggers
                    </h4>
                    <div id="available-events" class="grid grid-cols-2 gap-2 text-xs">
                        <div class="space-y-1">
                            <div class="font-semibold text-gray-600">External Events:</div>
                            <div class="text-gray-500">Loading available events...</div>
                        </div>
                        <div class="space-y-1">
                            <div class="font-semibold text-gray-600">Time-based:</div>
                            <div class="text-gray-500">
                                • Cron schedules (e.g., "every day at 9am")<br>
                                • Intervals (e.g., "every 2 hours")<br>
                                • Manual triggers
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Status Toggle -->
                <div class="flex items-center justify-between">
                    <label class="block text-sm font-medium text-gray-700">Status</label>
                    <label class="inline-flex items-center">
                        <input type="checkbox" id="enabled" name="enabled" checked
                               class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                        <span class="ml-2 text-sm text-gray-600">Enabled</span>
                    </label>
                </div>
                
                <!-- Modal Actions -->
                <div class="flex justify-end space-x-3 pt-4 border-t">
                    <button type="button" id="cancel-btn" class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 border border-transparent rounded-md text-sm font-medium text-white hover:bg-blue-700">
                        <span id="submit-text">Create Instruction</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Instruction Modal with Plan Visualization -->
<div id="edit-instruction-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-10 mx-auto p-5 border w-11/12 max-w-6xl shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <!-- Modal Header -->
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900">Edit Instruction</h3>
                <button id="close-edit-modal" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Left: Instruction Details & Critique -->
                <div class="space-y-4">
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h4 class="font-semibold text-gray-700 mb-3">Instruction Details</h4>
                        <div class="space-y-3">
                            <div>
                                <label class="text-sm font-medium text-gray-600">Name:</label>
                                <p id="edit-instruction-name" class="text-gray-900"></p>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-600">Status:</label>
                                <span id="edit-instruction-status" class="ml-2"></span>
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-600">Natural Language Description:</label>
                                <p id="edit-instruction-description" class="text-gray-900 mt-1"></p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-blue-50 rounded-lg p-4">
                        <h4 class="font-semibold text-gray-700 mb-3">Plan Summary</h4>
                        <p id="edit-plan-summary" class="text-gray-700 text-sm">Loading plan summary...</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Critique or Refine this Plan
                        </label>
                        <textarea id="edit-critique-text" rows="4" 
                                  placeholder="Describe how you'd like to modify this plan..."
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                        <button onclick="submitEditCritique()" 
                                class="mt-2 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm">
                            <i class="fas fa-sync-alt mr-1"></i>Regenerate Plan
                        </button>
                    </div>
                </div>
                
                <!-- Right: Plan Visualization -->
                <div class="space-y-4">
                    <div class="bg-white border rounded-lg p-4 h-full">
                        <h4 class="font-semibold text-gray-700 mb-3">Plan Visualization</h4>
                        <div id="plan-visualization" class="min-h-[400px]">
                            <div class="text-center py-8">
                                <i class="fas fa-spinner fa-spin text-gray-400 text-2xl"></i>
                                <p class="text-gray-500 mt-2">Loading plan visualization...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-end space-x-3 pt-4 border-t mt-6">
                <button type="button" onclick="closeEditModal()" 
                        class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{% endblock %}

{% block extra_scripts %}
<script>
// Available events - will be populated from the backend
let availableEvents = [];

// Load available events from the backend
async function loadAvailableEvents() {
    try {
        const response = await fetch('/api/events/types');
        if (response.ok) {
            const data = await response.json();
            availableEvents = data.external || [];
            
            // Update the events display
            const eventsContainer = document.querySelector('#available-events .space-y-1:first-child');
            if (eventsContainer && availableEvents.length > 0) {
                const eventsHtml = availableEvents.map(event => 
                    `• ${event}`
                ).join('<br>');
                eventsContainer.innerHTML = `
                    <div class="font-semibold text-gray-600">External Events:</div>
                    <div class="text-gray-500">${eventsHtml}</div>
                `;
            }
        }
    } catch (error) {
        console.error('Failed to load available events:', error);
    }
}

// Main code starts here
let instructions = [];
let editingInstructionId = null;

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    loadAvailableEvents();
    loadInstructions();
    setupEventListeners();
});

function setupEventListeners() {
    // Modal controls
    const createBtn = document.getElementById('create-instruction-btn');
    if (createBtn) {
        createBtn.addEventListener('click', () => {
            console.log('Create button clicked');
            openModal();
        });
    } else {
        console.error('Create instruction button not found!');
    }
    
    const closeBtn = document.getElementById('close-modal');
    if (closeBtn) {
        closeBtn.addEventListener('click', () => closeModal());
    }
    
    const cancelBtn = document.getElementById('cancel-btn');
    if (cancelBtn) {
        cancelBtn.addEventListener('click', () => closeModal());
    }
    
    document.getElementById('close-edit-modal')?.addEventListener('click', () => closeEditModal());
    
    // Form submission
    const form = document.getElementById('instruction-form');
    if (form) {
        form.addEventListener('submit', handleFormSubmit);
    }
}

async function handleFormSubmit(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const name = formData.get('name');
    const instructionText = formData.get('instruction_text');
    const enabled = formData.get('enabled') === 'on';
    
    // Convert natural language to structured format
    // In a real implementation, this would use NLP or the planner directly
    const instructionData = {
        name: name,
        description: instructionText,
        enabled: enabled,
        trigger: {
            event_type: "manual", // This will be extracted from the natural language
            providers: [],
            conditions: {}
        },
        action: {
            type: "conseil_task", // Default to AI-powered task
            config: {
                task_description: instructionText
            }
        }
    };
    
    try {
        const url = editingInstructionId ? `/api/instructions/${editingInstructionId}` : '/api/instructions';
        const method = editingInstructionId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(instructionData)
        });
        
        if (response.ok) {
            showSuccess(editingInstructionId ? 'Instruction updated successfully' : 'Instruction created successfully');
            closeModal();
            loadInstructions();
        } else {
            const error = await response.text();
            showError(`Failed to save instruction: ${error}`);
        }
    } catch (error) {
        console.error('Error saving instruction:', error);
        showError('Failed to save instruction');
    }
}

function openModal() {
    editingInstructionId = null;
    document.getElementById('modal-title').textContent = 'Create New Instruction';
    document.getElementById('submit-text').textContent = 'Create Instruction';
    document.getElementById('instruction-form').reset();
    const modal = document.getElementById('instruction-modal');
    modal.classList.add('show');
    console.log('Modal opened:', modal.classList.toString());
}

function closeModal() {
    const modal = document.getElementById('instruction-modal');
    modal.classList.remove('show');
    editingInstructionId = null;
}

function editInstruction(id) {
    const instruction = instructions.find(i => i.id === id);
    if (!instruction) return;
    
    // Show edit modal with plan visualization
    document.getElementById('edit-instruction-modal').classList.remove('hidden');
    
    // Populate instruction details
    document.getElementById('edit-instruction-name').textContent = instruction.name;
    document.getElementById('edit-instruction-status').innerHTML = instruction.enabled ? 
        '<span class="px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full">Enabled</span>' :
        '<span class="px-2 py-1 text-xs font-medium bg-gray-100 text-gray-800 rounded-full">Disabled</span>';
    document.getElementById('edit-instruction-description').textContent = instruction.description || 'No description available';
    
    // Load plan for this instruction
    loadPlanForEdit(id);
}

function closeEditModal() {
    document.getElementById('edit-instruction-modal').classList.add('hidden');
    document.getElementById('edit-critique-text').value = '';
}

async function loadPlanForEdit(instructionId) {
    const summaryElement = document.getElementById('edit-plan-summary');
    const vizElement = document.getElementById('plan-visualization');
    
    try {
        const response = await fetch(`/api/plans/instruction/${instructionId}`);
        if (response.ok) {
            const plan = await response.json();
            
            // Update summary
            summaryElement.textContent = plan.summary || 'No summary available';
            
            // Store current plan for critique
            window.currentEditPlan = plan;
            window.currentEditInstructionId = instructionId;
            
            // Render plan visualization
            renderPlanVisualization(plan, vizElement);
        } else {
            summaryElement.textContent = 'No plan generated yet';
            vizElement.innerHTML = '<p class="text-center text-gray-500 py-8">No plan to visualize</p>';
        }
    } catch (error) {
        console.error('Error loading plan:', error);
        summaryElement.textContent = 'Error loading plan';
    }
}

function renderPlanVisualization(plan, container) {
    // Simple visualization - in production, use a proper graph library like D3.js or vis.js
    const steps = plan.steps || [];
    if (steps.length === 0) {
        container.innerHTML = '<p class="text-center text-gray-500 py-8">No steps defined in plan</p>';
        return;
    }
    
    let html = '<div class="space-y-4">';
    
    // Show triggers
    const triggers = plan.external_triggers || [];
    if (triggers.length > 0) {
        html += `
            <div class="mb-4">
                <h5 class="font-semibold text-sm text-gray-700 mb-2">Triggers:</h5>
                <div class="flex flex-wrap gap-2">
                    ${triggers.map(t => `<span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-xs">${t}</span>`).join('')}
                </div>
            </div>
        `;
    }
    
    // Show steps as a flow
    html += '<div class="relative">';
    steps.forEach((step, index) => {
        const isLast = index === steps.length - 1;
        html += `
            <div class="flex items-start mb-4 ${!isLast ? 'pb-4 border-l-2 border-gray-300 ml-4' : ''}">
                <div class="bg-white border-2 border-gray-300 rounded-full p-2 -ml-4 ${!isLast ? 'mb-0' : ''}">
                    <span class="text-sm font-semibold text-gray-600">${index + 1}</span>
                </div>
                <div class="ml-4 flex-1">
                    <div class="bg-gray-50 rounded-lg p-3">
                        <h6 class="font-semibold text-sm text-gray-800">${step.name || `Step ${index + 1}`}</h6>
                        <p class="text-xs text-gray-600 mt-1">Action: ${step.action || 'Unknown'}</p>
                        ${step.requires ? `<p class="text-xs text-gray-500 mt-1">Requires: ${step.requires.join(', ')}</p>` : ''}
                        ${step.produces ? `<p class="text-xs text-green-600 mt-1">Produces: ${step.produces.join(', ')}</p>` : ''}
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div></div>';
    
    container.innerHTML = html;
}

async function submitEditCritique() {
    const critiqueText = document.getElementById('edit-critique-text').value.trim();
    if (!critiqueText) {
        showError('Please provide your feedback');
        return;
    }
    
    if (!window.currentEditPlan || !window.currentEditInstructionId) {
        showError('No plan loaded');
        return;
    }
    
    try {
        const response = await fetch(`/api/plans/${window.currentEditPlan.id}/critique`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                critique: critiqueText,
                instruction_id: window.currentEditInstructionId
            })
        });
        
        if (response.ok) {
            showSuccess('Plan regenerated successfully!');
            document.getElementById('edit-critique-text').value = '';
            
            // Reload the plan
            loadPlanForEdit(window.currentEditInstructionId);
        } else {
            const error = await response.text();
            showError(`Failed to regenerate plan: ${error}`);
        }
    } catch (error) {
        console.error('Error submitting critique:', error);
        showError('Failed to regenerate plan');
    }
}

// Load and display instructions
async function loadInstructions() {
    try {
        console.log('Loading instructions...');
        const response = await fetch('/api/instructions');
        console.log('Response status:', response.status);
        
        if (response.ok) {
            instructions = await response.json();
            console.log('Loaded instructions:', instructions.length);
            renderInstructions();
            updateStats();
        } else {
            console.error('Failed to load instructions:', response.status, response.statusText);
            showError('Failed to load instructions');
        }
    } catch (error) {
        console.error('Failed to load instructions:', error);
        showError('Failed to load instructions');
    }
}

// Render instructions (keeping the original logic)
function renderInstructions() {
    const container = document.getElementById('instructions-container');
    console.log('Rendering instructions, container:', !!container);
    if (!container) {
        console.error('Instructions container not found!');
        return;
    }
    
    if (instructions.length === 0) {
        container.innerHTML = `
            <div class="text-center py-8">
                <i class="fas fa-lightbulb text-gray-400 text-5xl mb-4"></i>
                <p class="text-gray-500">No instructions yet. Create your first one!</p>
            </div>
        `;
        return;
    }
    
    const html = instructions.map(instruction => `
        <div class="border rounded-lg p-6 mb-4 hover:shadow-md transition-shadow">
            <div class="flex justify-between items-start mb-4">
                <div class="flex-1">
                    <h4 class="text-lg font-medium text-gray-900 flex items-center">
                        ${instruction.name}
                        ${instruction.enabled ? 
                            '<span class="ml-2 px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full">Active</span>' : 
                            '<span class="ml-2 px-2 py-1 text-xs font-medium bg-gray-100 text-gray-800 rounded-full">Inactive</span>'
                        }
                    </h4>
                    ${instruction.description ? `<p class="text-sm text-gray-600 mt-1">${instruction.description}</p>` : ''}
                </div>
                <div class="flex space-x-2 ml-4">
                    <button onclick="editInstruction('${instruction.id}')" 
                            class="p-2 text-gray-400 hover:text-blue-600" title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="toggleInstruction('${instruction.id}')" 
                            class="p-2 text-gray-400 hover:text-yellow-600" title="Toggle">
                        <i class="fas fa-power-off"></i>
                    </button>
                    <button onclick="deleteInstruction('${instruction.id}')" 
                            class="p-2 text-gray-400 hover:text-red-600" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            
            <div class="mt-4 pt-4 border-t border-gray-200" id="plan-summary-${instruction.id}">
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <span class="font-medium text-gray-700">Plan Summary:</span>
                        <div class="mt-1 text-sm text-gray-600" id="plan-summary-content-${instruction.id}">
                            <span class="text-gray-400">Loading plan...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
    
    container.innerHTML = html;
    
    // Load plan summaries
    instructions.forEach(instruction => {
        loadPlanSummary(instruction.id);
    });
}

function updateStats() {
    document.getElementById('total-instructions').textContent = instructions.length;
    document.getElementById('active-instructions').textContent = instructions.filter(i => i.enabled).length;
    document.getElementById('total-executions').textContent = instructions.reduce((sum, i) => sum + (i.execution_count || 0), 0);
    
    const lastExecution = instructions
        .filter(i => i.last_executed_at)
        .sort((a, b) => new Date(b.last_executed_at) - new Date(a.last_executed_at))[0];
    
    document.getElementById('last-execution').textContent = lastExecution ? 
        new Date(lastExecution.last_executed_at).toLocaleDateString() : 'Never';
}

async function toggleInstruction(id) {
    try {
        const response = await fetch(`/api/instructions/${id}/toggle`, {
            method: 'PATCH'
        });
        
        if (response.ok) {
            loadInstructions();
            showSuccess('Instruction status updated');
        } else {
            showError('Failed to toggle instruction');
        }
    } catch (error) {
        console.error('Error toggling instruction:', error);
        showError('Failed to toggle instruction');
    }
}

async function deleteInstruction(id) {
    if (!confirm('Are you sure you want to delete this instruction?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/instructions/${id}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            loadInstructions();
            showSuccess('Instruction deleted successfully');
        } else {
            showError('Failed to delete instruction');
        }
    } catch (error) {
        console.error('Error deleting instruction:', error);
        showError('Failed to delete instruction');
    }
}

function showSuccess(message) {
    const toast = document.createElement('div');
    toast.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

function showError(message) {
    const toast = document.createElement('div');
    toast.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 5000);
}

// Load plan summary for an instruction
async function loadPlanSummary(instructionId) {
    const summaryElement = document.getElementById(`plan-summary-content-${instructionId}`);
    if (!summaryElement) return;
    
    try {
        const response = await fetch(`/api/plans/instruction/${instructionId}`);
        if (response.ok) {
            const plan = await response.json();
            if (plan.error) {
                // Display plan generation error
                summaryElement.innerHTML = `
                    <div class="text-red-600">
                        <span class="font-semibold">Plan generation failed:</span>
                        <p class="text-sm mt-1">${plan.error_message || 'Unknown error occurred during plan generation'}</p>
                    </div>
                `;
            } else if (plan.summary) {
                summaryElement.innerHTML = `<p class="text-gray-700">${plan.summary}</p>`;
            } else {
                summaryElement.innerHTML = '<span class="text-gray-400 italic">No plan summary available</span>';
            }
        } else if (response.status === 404) {
            summaryElement.innerHTML = '<span class="text-gray-400 italic">Plan generation in progress...</span>';
        } else {
            summaryElement.innerHTML = '<span class="text-red-500">Error loading plan</span>';
        }
    } catch (error) {
        console.error(`Error loading plan for instruction ${instructionId}:`, error);
        summaryElement.innerHTML = '<span class="text-red-500">Error loading plan</span>';
    }
}
</script>
{% endblock %}
