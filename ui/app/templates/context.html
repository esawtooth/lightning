{% extends "base.html" %}

{% block title %}My Context Hub - Vextir{% endblock %}
{% block page_title %}My Context Hub{% endblock %}

{% block extra_head %}
<!-- JSTree CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.16/themes/default/style.min.css" />
<!-- TipTap Editor CSS -->
<link rel="stylesheet" href="{{ url_for('static', path='css/tiptap-editor.css') }}" />
<!-- Inline File Tree CSS -->
<link rel="stylesheet" href="{{ url_for('static', path='css/inline-file-tree.css') }}" />
<style>
    /* Make the main content area full height */
    #main-content {
        height: calc(100vh - 220px); /* Adjust based on header height */
    }
    
    #main-content > div {
        height: 100%;
    }
    
    /* Action icons styling */
    .tree-actions {
        display: none;
    }
    
    .jstree-hovered .tree-actions,
    .jstree-clicked .tree-actions {
        display: inline-block !important;
    }
</style>
{% endblock %}

{% block content %}
<!-- Unified Top Control Bar -->
<div class="mb-6 bg-white rounded-lg shadow p-4">
    <div class="flex items-center gap-2 flex-wrap">
        <!-- Context Status -->
        <div class="flex items-center gap-2">
            <div id="context-status" class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-600">
                <i class="fas fa-spinner fa-spin mr-1"></i>
                Loading...
            </div>
            <button id="init-context-btn" onclick="initializeContext()" class="hidden bg-blue-500 text-white px-3 py-1.5 rounded text-sm hover:bg-blue-600 transition-colors">
                <i class="fas fa-plus mr-1"></i>
                Initialize
            </button>
        </div>
        
        <!-- Search Bar (smaller) -->
        <div class="flex items-center gap-2 flex-1 max-w-md">
            <input 
                type="text" 
                id="search-input" 
                placeholder="Search..."
                class="flex-1 border border-gray-300 rounded px-3 py-1.5 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                onkeypress="handleSearchKeypress(event)"
            >
            <button onclick="searchContext()" class="bg-blue-500 text-white px-3 py-1.5 rounded text-sm hover:bg-blue-600 transition-colors">
                <i class="fas fa-search"></i>
            </button>
        </div>
        
        <!-- Quick Actions -->
        <button onclick="showUploadModal()" class="bg-blue-500 text-white px-3 py-1.5 rounded text-sm hover:bg-blue-600 transition-colors">
            <i class="fas fa-upload mr-1"></i>
            Upload
        </button>
        <button onclick="exportContext()" class="bg-purple-500 text-white px-3 py-1.5 rounded text-sm hover:bg-purple-600 transition-colors">
            <i class="fas fa-download mr-1"></i>
            Export
        </button>
        
        <!-- Keyboard Shortcuts Hint -->
        <div class="border-l border-gray-300 pl-2 text-xs text-gray-600">
            <span class="hidden lg:inline">
                <kbd class="px-1 py-0.5 bg-gray-100 border border-gray-300 rounded text-xs">Ctrl+N</kbd> New File
                <span class="mx-1">â€¢</span>
                <kbd class="px-1 py-0.5 bg-gray-100 border border-gray-300 rounded text-xs">Ctrl+Shift+N</kbd> New Folder
            </span>
        </div>
        
        <!-- Refresh -->
        <button id="refresh-btn" onclick="refreshContext()" class="bg-gray-500 text-white px-3 py-1.5 rounded text-sm hover:bg-gray-600 transition-colors">
            <i class="fas fa-sync-alt"></i>
        </button>
    </div>
    
    <!-- Search Results (hidden by default) -->
    <div id="search-results" class="mt-4 hidden">
        <h4 class="font-medium text-gray-900 mb-2 text-sm">Search Results</h4>
        <div id="search-results-list" class="space-y-1"></div>
    </div>
</div>

<!-- Hidden info div for status messages -->
<div id="context-info" class="hidden"></div>

<!-- Main Content - Side by Side Layout -->
<div id="main-content" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Folder Browser (Left Side) -->
    <div class="lg:col-span-1">
        <div class="bg-white rounded-lg shadow h-full flex flex-col">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">Files & Folders</h3>
            </div>
            <div class="p-4 flex-1 overflow-hidden relative">
                <div id="folder-browser" class="h-full overflow-y-auto">
                    <!-- JSTree will be initialized here -->
                </div>
                <div id="no-context" class="text-center py-8 text-gray-500 hidden">
                    <i class="fas fa-folder-open text-4xl mb-4"></i>
                    <p>Your context hub is not initialized yet.</p>
                    <p class="text-sm">Click "Initialize Context Hub" to get started.</p>
                </div>
                <!-- Quick action buttons -->
                <div class="tree-quick-actions">
                    <button onclick="window.fileTree && window.fileTree.createFileInline(contextData.selectedFolder?.id)" 
                            class="tree-quick-action" title="New File (Ctrl+N)">
                        <i class="fas fa-file-plus"></i>
                        <span>File</span>
                    </button>
                    <button onclick="window.fileTree && window.fileTree.createFolderInline(contextData.selectedFolder?.id)" 
                            class="tree-quick-action" title="New Folder (Ctrl+Shift+N)">
                        <i class="fas fa-folder-plus"></i>
                        <span>Folder</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Document Viewer/Editor (Right Side) -->
    <div class="lg:col-span-2">
        <div class="bg-white rounded-lg shadow h-full flex flex-col">
            <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <i id="doc-icon" class="fas fa-file-alt text-gray-500"></i>
                    <h3 id="doc-title" class="text-lg font-medium text-gray-900">Select a Document</h3>
                </div>
                <div id="doc-actions" class="hidden flex space-x-2">
                    <button onclick="saveDocument()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors text-sm">
                        <i class="fas fa-save mr-2"></i>
                        Save
                    </button>
                </div>
            </div>
            <div class="p-6 flex-1 overflow-hidden">
                <div id="doc-placeholder" class="text-center py-16 text-gray-500">
                    <i class="fas fa-file-alt text-6xl mb-4"></i>
                    <p class="text-lg">Select a document to view or edit</p>
                    <p class="text-sm mt-2">Click on any file in the tree to open it</p>
                </div>
                <div id="doc-editor" class="hidden w-full h-full">
                    <!-- TipTap editor will be initialized here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Note: Create Document and Folder modals removed - using inline creation instead -->

<!-- Upload Modal -->
<div id="upload-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">Upload File</h3>
            </div>
            <div class="p-6">
                <div class="text-center py-8">
                    <i class="fas fa-upload text-4xl text-gray-400 mb-4"></i>
                    <p class="text-gray-600 mb-4">File upload functionality coming soon!</p>
                    <p class="text-sm text-gray-500">For now, you can create documents manually using the "Create Document" feature.</p>
                </div>
                <div class="flex justify-end">
                    <button onclick="closeUploadModal()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">Close</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- jQuery (required for JSTree) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<!-- JSTree JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.16/jstree.min.js"></script>
<!-- TipTap Editor -->
<script src="https://unpkg.com/@tiptap/core@2.1.13/dist/index.umd.js"></script>
<script src="https://unpkg.com/@tiptap/pm@2.1.13/dist/index.umd.js"></script>
<script src="https://unpkg.com/@tiptap/starter-kit@2.1.13/dist/index.umd.js"></script>
<script>
// Make TipTap available globally for our editor component
window.TipTap = window.tiptapCore;
window.TipTapStarterKit = window.StarterKit;
</script>
<!-- Our TipTap Editor Component -->
<script src="{{ url_for('static', path='js/tiptap-editor.js') }}"></script>
<!-- Inline File Tree Component -->
<script src="{{ url_for('static', path='js/inline-file-tree.js') }}"></script>
<!-- Offline Queue Manager -->
<script src="{{ url_for('static', path='js/offline-queue.js') }}"></script>
<script>
    // Context hub functionality
    let contextData = {
        status: null,
        folders: null,
        selectedDocument: null,
        editorMode: false,
        editor: null,  // TipTap editor instance
        fileTree: null  // Inline file tree instance
    };

    async function loadContextStatus() {
        try {
            const response = await fetch('/api/context/status');
            if (response.ok) {
                const data = await response.json();
                contextData.status = data;
                updateStatusDisplay(data);
            } else {
                updateStatusDisplay({ initialized: false });
            }
        } catch (error) {
            console.error('Failed to load context status:', error);
            updateStatusDisplay({ initialized: false });
        }
    }

    function updateStatusDisplay(status) {
        const statusEl = document.getElementById('context-status');
        const initBtn = document.getElementById('init-context-btn');
        const noContextEl = document.getElementById('no-context');

        if (status.initialized) {
            statusEl.innerHTML = '<i class="fas fa-check-circle mr-1"></i> Ready';
            statusEl.className = 'px-2 py-1 text-xs rounded-full bg-green-100 text-green-800';
            initBtn.classList.add('hidden');
            if (noContextEl) noContextEl.classList.add('hidden');
            loadFolders();
        } else {
            statusEl.innerHTML = '<i class="fas fa-exclamation-circle mr-1"></i> Not Ready';
            statusEl.className = 'px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800';
            initBtn.classList.remove('hidden');
            if (noContextEl) noContextEl.classList.remove('hidden');
        }
    }

    async function initializeContext() {
        try {
            const response = await fetch('/api/context/initialize', { method: 'POST' });
            if (response.ok) {
                // Silent success, just reload
                loadContextStatus();
            } else {
                console.error('Failed to initialize context hub');
            }
        } catch (error) {
            console.error('Error initializing context:', error);
        }
    }

    async function loadFolders() {
        try {
            const response = await fetch('/api/context/folders');
            if (response.ok) {
                const data = await response.json();
                contextData.folders = data;
                updateFolderDisplay(data);
            }
        } catch (error) {
            console.error('Failed to load folders:', error);
        }
    }

    function buildJSTreeData(folders) {
        if (!folders || !folders.tree) {
            return [];
        }
        
        function convertFolderToJSTreeNode(folder) {
            const node = {
                id: folder.id,
                text: `${folder.name} (${folder.document_count || 0} documents)`,
                icon: folder.id === 'root' ? 'fas fa-home' : 'fas fa-folder',
                type: 'folder',
                state: { opened: true },
                data: folder,
                children: []
            };
            
            // Add documents as child nodes
            if (folder.documents && folder.documents.length > 0) {
                folder.documents.forEach(doc => {
                    node.children.push({
                        id: `doc_${doc.id}`,
                        text: doc.name,
                        icon: 'fas fa-file-alt',
                        type: 'file',
                        data: doc
                    });
                });
            }
            
            // Add subfolders recursively
            if (folder.subfolders && folder.subfolders.length > 0) {
                folder.subfolders.forEach(subfolder => {
                    node.children.push(convertFolderToJSTreeNode(subfolder));
                });
            }
            
            return node;
        }
        
        return folders.tree.map(convertFolderToJSTreeNode);
    }
    
    function updateFolderDisplay(folders) {
        const browserEl = document.getElementById('folder-browser');
        
        if (!folders || !folders.folders) {
            browserEl.innerHTML = '<p class="text-gray-500">No folders found</p>';
            return;
        }
        
        // Destroy existing JSTree if it exists
        if ($.jstree && $('#folder-browser').jstree(true)) {
            $('#folder-browser').jstree('destroy');
        }
        
        const treeData = buildJSTreeData(folders);
        
        // Initialize JSTree
        $('#folder-browser').jstree({
            'core': {
                'data': treeData,
                'check_callback': true,
                'themes': {
                    'name': 'default',
                    'responsive': true
                }
            },
            'plugins': ['wholerow', 'types'],
            'types': {
                'default': {
                    'icon': 'fas fa-folder'
                },
                'document': {
                    'icon': 'fas fa-file-alt'
                }
            }
        }).on('select_node.jstree', function (e, data) {
            // Handle folder or document selection
            if (data.node.type === 'file') {
                // Document selected - load it for viewing/editing
                loadDocument(data.node.data);
            } else {
                // Folder selected - store for creating subfolders and show index guide
                contextData.selectedFolder = data.node.data;
                console.log('Selected folder:', contextData.selectedFolder);
                displayFolderGuide(data.node.data);
            }
        }).on('ready.jstree', function() {
            // Tree is ready
            console.log('JSTree initialized successfully');
            
            // Initialize inline file tree handler
            if (!contextData.fileTree) {
                contextData.fileTree = new InlineFileTree({
                    onCreateFile: createDocumentAPI,
                    onCreateFolder: createFolderAPI,
                    onRename: renameItemAPI,
                    onDelete: deleteItemAPI,
                    onSelect: (node) => {
                        if (node.type === 'file') {
                            loadDocument(node.data);
                        } else {
                            displayFolderGuide(node.data);
                        }
                    }
                });
                
                // Setup keyboard shortcuts
                contextData.fileTree.setupKeyboardShortcuts();
                
                // Make it globally accessible for onclick handlers
                window.fileTree = contextData.fileTree;
            }
            
            // Update node texts to include action buttons
            const tree = $('#folder-browser').jstree(true);
            const nodes = tree.get_json('#', { flat: true });
            nodes.forEach(node => {
                if (node.id && node.data && node.data.name) {
                    const nodeType = node.type || 'folder';
                    const newText = contextData.fileTree.createNodeText(node.data.name, nodeType, node.id);
                    tree.set_text(node.id, newText);
                }
            });
        });
    }
    
    async function displayFolderGuide(folder) {
        console.log('Displaying folder guide:', folder);
        
        // Clear selected document
        contextData.selectedDocument = null;
        
        // Update display to show folder guide
        const title = folder.name || 'Folder';
        
        window.document.getElementById('doc-icon').className = 'fas fa-folder text-gray-500';
        window.document.getElementById('doc-title').textContent = title + ' - Folder Guide';
        
        // Check if folder has an index_guide_id
        if (folder.index_guide_id) {
            // Load the Index Guide as an editable document
            try {
                const response = await fetch(`/api/context/documents/${folder.index_guide_id}`);
                if (response.ok) {
                    const docData = await response.json();
                    contextData.selectedDocument = docData;
                    
                    // Update document display - make it editable
                    window.document.getElementById('doc-icon').className = 'fas fa-book text-gray-500';
                    window.document.getElementById('doc-title').textContent = title + ' - Index Guide';
                    
                    // Initialize or update TipTap editor
                    if (!contextData.editor) {
                        contextData.editor = new ContextHubEditor('doc-editor', {
                            content: docData.content || '',
                            documentId: docData.id,
                            documentName: docData.name,
                            onSave: async (content) => {
                                // Save document via API
                                await saveDocumentContent(content);
                            }
                        });
                    } else {
                        contextData.editor.setContent(docData.content || '');
                        contextData.editor.options.documentId = docData.id;
                        contextData.editor.options.documentName = docData.name;
                    }
                    
                    // Show editor and save button
                    window.document.getElementById('doc-placeholder').classList.add('hidden');
                    window.document.getElementById('doc-editor').classList.remove('hidden');
                    window.document.getElementById('doc-actions').classList.remove('hidden');
                } else {
                    console.error('Failed to load Index Guide document');
                    showNoIndexGuidePlaceholder(folder, title);
                }
            } catch (error) {
                console.error('Error loading Index Guide:', error);
                showNoIndexGuidePlaceholder(folder, title);
            }
        } else {
            showNoIndexGuidePlaceholder(folder, title);
        }
    }
    
    function showNoIndexGuidePlaceholder(folder, title) {
        // Show placeholder with folder info
        const placeholder = window.document.getElementById('doc-placeholder');
        placeholder.innerHTML = `
            <i class="fas fa-folder text-6xl mb-4"></i>
            <p class="text-lg font-medium">${title}</p>
            <p class="text-sm mt-2">This folder has no Index Guide yet.</p>
            <p class="text-sm mt-1">Index Guides help organize content within folders.</p>
            <button onclick="createIndexGuide('${folder.id}', '${title.replace(/'/g, "\\'")}')" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                <i class="fas fa-plus mr-2"></i>Create Index Guide
            </button>
        `;
        placeholder.classList.remove('hidden');
        window.document.getElementById('doc-editor').classList.add('hidden');
        window.document.getElementById('doc-actions').classList.add('hidden');
    }
    
    async function loadDocument(document) {
        console.log('Loading document:', document);
        
        try {
            // Fetch the full document content
            const response = await fetch(`/api/context/documents/${document.id}`);
            if (!response.ok) {
                throw new Error('Failed to load document');
            }
            
            const docData = await response.json();
            contextData.selectedDocument = docData;
            
            // Update document display
            window.document.getElementById('doc-icon').className = 'fas fa-file-alt text-gray-500';
            window.document.getElementById('doc-title').textContent = docData.name;
            
            // Initialize or update TipTap editor
            if (!contextData.editor) {
                contextData.editor = new ContextHubEditor('doc-editor', {
                    content: docData.content || '',
                    documentId: docData.id,
                    documentName: docData.name,
                    onSave: async (content) => {
                        // Save document via API
                        await saveDocumentContent(content);
                    }
                });
            } else {
                contextData.editor.setContent(docData.content || '');
                contextData.editor.options.documentId = docData.id;
                contextData.editor.options.documentName = docData.name;
            }
            
            // Show editor, hide placeholder
            window.document.getElementById('doc-placeholder').classList.add('hidden');
            window.document.getElementById('doc-editor').classList.remove('hidden');
            window.document.getElementById('doc-actions').classList.remove('hidden');
            
        } catch (error) {
            console.error('Error loading document:', error);
            // Show error in placeholder instead of alert
            window.document.getElementById('doc-placeholder').innerHTML = `
                <i class="fas fa-exclamation-circle text-6xl mb-4 text-red-500"></i>
                <p class="text-lg">Failed to load document</p>
                <p class="text-sm mt-2">${error.message}</p>
            `;
            window.document.getElementById('doc-placeholder').classList.remove('hidden');
            window.document.getElementById('doc-editor').classList.add('hidden');
            window.document.getElementById('doc-actions').classList.add('hidden');
        }
    }
    
    async function saveDocument() {
        if (!contextData.selectedDocument || !contextData.editor) {
            console.error('No document selected or editor not initialized');
            return;
        }
        
        // Force save the current content
        await contextData.editor.save();
    }
    
    async function saveDocumentContent(content) {
        if (!contextData.selectedDocument) {
            throw new Error('No document selected');
        }
        
        try {
            const response = await fetch(`/api/context/documents/${contextData.selectedDocument.id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: contextData.selectedDocument.name,
                    content: content
                })
            });
            
            if (response.ok) {
                // Update local document data
                contextData.selectedDocument.content = content;
                
                // Show success feedback
                const saveBtn = document.querySelector('button[onclick="saveDocument()"]');
                if (saveBtn) {
                    const originalText = saveBtn.innerHTML;
                    saveBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Saved';
                    saveBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                    saveBtn.classList.add('bg-green-700');
                    
                    setTimeout(() => {
                        saveBtn.innerHTML = originalText;
                        saveBtn.classList.remove('bg-green-700');
                        saveBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                    }, 2000);
                }
                
                // Refresh folder data to update any counts
                loadFolders();
            } else {
                throw new Error('Failed to save document');
            }
        } catch (error) {
            console.error('Error saving document:', error);
            throw error;
        }
    }


    async function searchContext() {
        const query = document.getElementById('search-input').value.trim();
        if (!query) return;

        try {
            const response = await fetch(`/api/context/search?q=${encodeURIComponent(query)}&limit=10`);
            if (response.ok) {
                const data = await response.json();
                displaySearchResults(data);
            } else {
                console.error('Search failed');
            }
        } catch (error) {
            console.error('Search error:', error);
        }
    }

    function displaySearchResults(results) {
        const resultsEl = document.getElementById('search-results');
        const listEl = document.getElementById('search-results-list');
        
        listEl.innerHTML = '';
        
        if (!results.results || results.results.length === 0) {
            listEl.innerHTML = '<p class="text-gray-500">No results found</p>';
        } else {
            results.results.forEach(result => {
                const resultEl = document.createElement('div');
                resultEl.className = 'border border-gray-200 rounded-lg p-3';
                resultEl.innerHTML = `
                    <div class="font-medium text-gray-900">${result.name}</div>
                    <div class="text-sm text-gray-600 mt-1">${result.content ? result.content.substring(0, 200) + '...' : 'No content preview'}</div>
                `;
                listEl.appendChild(resultEl);
            });
        }
        
        resultsEl.classList.remove('hidden');
    }

    function handleSearchKeypress(event) {
        if (event.key === 'Enter') {
            searchContext();
        }
    }

    async function refreshContext() {
        // Show loading state on refresh button
        const refreshBtn = document.getElementById('refresh-btn');
        const originalHTML = refreshBtn.innerHTML;
        refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        refreshBtn.disabled = true;
        
        try {
            // Refresh all components
            await loadContextStatus();
            await loadFolders();
            
            // If a document is currently selected, reload it by fetching fresh data
            if (contextData.selectedDocument && contextData.selectedDocument.id) {
                // Re-fetch the document to get latest content
                await loadDocument({id: contextData.selectedDocument.id, name: contextData.selectedDocument.name});
            }
        } finally {
            // Restore button state
            refreshBtn.innerHTML = originalHTML;
            refreshBtn.disabled = false;
        }
    }

    // Removed modal functions - using inline creation instead

    function showUploadModal() {
        document.getElementById('upload-modal').classList.remove('hidden');
    }

    function closeUploadModal() {
        document.getElementById('upload-modal').classList.add('hidden');
    }

    function exportContext() {
        // Silent - no alert for unimplemented features
        console.log('Export functionality not yet implemented');
    }

    // Removed modal form handlers - using inline creation instead

    // Initialize page
    document.addEventListener('DOMContentLoaded', () => {
        // Initialize offline queue
        window.offlineQueue = new OfflineQueue({
            onSync: (completed, failed) => {
                console.log('Offline sync completed:', completed.length, 'succeeded,', failed.length, 'failed');
                // Refresh folders if any operations completed
                if (completed.length > 0) {
                    loadFolders();
                }
            },
            onError: (operation, error) => {
                console.error('Offline operation failed permanently:', operation, error);
            }
        });
        
        loadContextStatus();
    });
    
    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
        if (contextData.editor) {
            contextData.editor.destroy();
        }
    });

    // Close upload modal when clicking outside
    document.getElementById('upload-modal').addEventListener('click', (e) => {
        if (e.target.id === 'upload-modal') {
            closeUploadModal();
        }
    });

    // API functions for inline file tree
    async function createDocumentAPI(name, content, parentFolderId) {
        try {
            const response = await fetch('/api/context/documents', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: name,
                    content: content || '',
                    folder_id: parentFolderId
                })
            });
            
            if (response.ok) {
                const result = await response.json();
                loadFolders(); // Refresh tree
                return result;
            } else {
                throw new Error('Failed to create document');
            }
        } catch (error) {
            console.error('Error creating document:', error);
            throw error;
        }
    }
    
    async function createFolderAPI(name, parentFolderId) {
        try {
            const response = await fetch('/api/context/folders', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: name,
                    parent_id: parentFolderId
                })
            });
            
            if (response.ok) {
                const result = await response.json();
                loadFolders(); // Refresh tree
                return result;
            } else {
                throw new Error('Failed to create folder');
            }
        } catch (error) {
            console.error('Error creating folder:', error);
            throw error;
        }
    }
    
    async function renameItemAPI(itemId, newName, itemType) {
        try {
            const endpoint = itemType === 'folder' ? 
                `/api/context/folders/${itemId}` : 
                `/api/context/documents/${itemId.replace('doc_', '')}`;
                
            const response = await fetch(endpoint, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ name: newName })
            });
            
            if (response.ok) {
                return await response.json();
            } else {
                throw new Error(`Failed to rename ${itemType}`);
            }
        } catch (error) {
            console.error(`Error renaming ${itemType}:`, error);
            throw error;
        }
    }
    
    async function deleteItemAPI(itemId, itemType) {
        try {
            const endpoint = itemType === 'folder' ? 
                `/api/context/folders/${itemId}` : 
                `/api/context/documents/${itemId.replace('doc_', '')}`;
            
            const response = await fetch(endpoint, { method: 'DELETE' });
            
            if (response.ok) {
                loadFolders(); // Refresh tree
                return true;
            } else {
                throw new Error(`Failed to delete ${itemType}`);
            }
        } catch (error) {
            console.error(`Error deleting ${itemType}:`, error);
            throw error;
        }
    }

    // Delete item function (legacy, for backwards compatibility)
    async function deleteItem(itemId, itemType, itemName) {
        return deleteItemAPI(itemId, itemType);
    }

    // Quick create - removed in favor of inline creation
    
    // Create Index Guide for a folder
    async function createIndexGuide(folderId, folderName) {
        const defaultContent = `# ${folderName} Folder

## Purpose
This folder is for organizing your ${folderName.toLowerCase()} content.

## Organization Guidelines
- Keep related documents together
- Use descriptive names for your files
- Consider creating subfolders for better organization
- Update documents regularly to keep information current

## Best Practices
- Add dates to time-sensitive documents
- Use consistent naming conventions
- Include relevant keywords for easy searching
- Regular review and cleanup of outdated content
`;
        
        try {
            const response = await fetch('/api/context/documents', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: 'Index Guide',
                    content: defaultContent,
                    folder_id: folderId,
                    doc_type: 'IndexGuide'
                })
            });
            
            if (response.ok) {
                // Silent success
                await loadFolders();
                // Re-display the folder with the new guide
                const folder = contextData.folders?.folders?.find(f => f.id === folderId);
                if (folder) {
                    folder.index_guide = defaultContent;
                    displayFolderGuide(folder);
                }
            } else {
                console.error('Failed to create Index Guide');
            }
        } catch (error) {
            console.error('Error creating Index Guide:', error);
        }
    }
</script>
{% endblock %}
