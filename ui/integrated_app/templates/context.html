{% extends "base.html" %}

{% block title %}My Context Hub - Vextir{% endblock %}
{% block page_title %}My Context Hub{% endblock %}

{% block extra_head %}
<!-- JSTree CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.16/themes/default/style.min.css" />
<style>
    /* Make the main content area full height */
    #main-content {
        height: calc(100vh - 220px); /* Adjust based on header height */
    }
    
    #main-content > div {
        height: 100%;
    }
    
    /* Action icons styling */
    .tree-actions {
        display: none;
    }
    
    .jstree-hovered .tree-actions,
    .jstree-clicked .tree-actions {
        display: inline-block !important;
    }
</style>
{% endblock %}

{% block content %}
<!-- Unified Top Control Bar -->
<div class="mb-6 bg-white rounded-lg shadow p-4">
    <div class="flex items-center gap-2 flex-wrap">
        <!-- Context Status -->
        <div class="flex items-center gap-2">
            <div id="context-status" class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-600">
                <i class="fas fa-spinner fa-spin mr-1"></i>
                Loading...
            </div>
            <button id="init-context-btn" onclick="initializeContext()" class="hidden bg-blue-500 text-white px-3 py-1.5 rounded text-sm hover:bg-blue-600 transition-colors">
                <i class="fas fa-plus mr-1"></i>
                Initialize
            </button>
        </div>
        
        <!-- Search Bar (smaller) -->
        <div class="flex items-center gap-2 flex-1 max-w-md">
            <input 
                type="text" 
                id="search-input" 
                placeholder="Search..."
                class="flex-1 border border-gray-300 rounded px-3 py-1.5 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                onkeypress="handleSearchKeypress(event)"
            >
            <button onclick="searchContext()" class="bg-blue-500 text-white px-3 py-1.5 rounded text-sm hover:bg-blue-600 transition-colors">
                <i class="fas fa-search"></i>
            </button>
        </div>
        
        <!-- Quick Actions -->
        <button onclick="showCreateDocumentModal()" class="bg-green-500 text-white px-3 py-1.5 rounded text-sm hover:bg-green-600 transition-colors">
            <i class="fas fa-file-alt mr-1"></i>
            Create
        </button>
        <button onclick="showUploadModal()" class="bg-blue-500 text-white px-3 py-1.5 rounded text-sm hover:bg-blue-600 transition-colors">
            <i class="fas fa-upload mr-1"></i>
            Upload
        </button>
        <button onclick="exportContext()" class="bg-purple-500 text-white px-3 py-1.5 rounded text-sm hover:bg-purple-600 transition-colors">
            <i class="fas fa-download mr-1"></i>
            Export
        </button>
        
        <!-- Folder/Document Actions -->
        <div class="border-l border-gray-300 pl-2">
            <button onclick="showCreateFolderModal()" class="bg-indigo-500 text-white px-3 py-1.5 rounded text-sm hover:bg-indigo-600 transition-colors">
                <i class="fas fa-folder-plus mr-1"></i>
                New Folder
            </button>
            <button onclick="showCreateDocumentModal()" class="bg-teal-500 text-white px-3 py-1.5 rounded text-sm hover:bg-teal-600 transition-colors">
                <i class="fas fa-plus mr-1"></i>
                New Document
            </button>
        </div>
        
        <!-- Refresh -->
        <button id="refresh-btn" onclick="refreshContext()" class="bg-gray-500 text-white px-3 py-1.5 rounded text-sm hover:bg-gray-600 transition-colors">
            <i class="fas fa-sync-alt"></i>
        </button>
    </div>
    
    <!-- Search Results (hidden by default) -->
    <div id="search-results" class="mt-4 hidden">
        <h4 class="font-medium text-gray-900 mb-2 text-sm">Search Results</h4>
        <div id="search-results-list" class="space-y-1"></div>
    </div>
</div>

<!-- Hidden info div for status messages -->
<div id="context-info" class="hidden"></div>

<!-- Main Content - Side by Side Layout -->
<div id="main-content" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Folder Browser (Left Side) -->
    <div class="lg:col-span-1">
        <div class="bg-white rounded-lg shadow h-full flex flex-col">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">Files & Folders</h3>
            </div>
            <div class="p-4 flex-1 overflow-hidden">
                <div id="folder-browser" class="h-full overflow-y-auto">
                    <!-- JSTree will be initialized here -->
                </div>
                <div id="no-context" class="text-center py-8 text-gray-500 hidden">
                    <i class="fas fa-folder-open text-4xl mb-4"></i>
                    <p>Your context hub is not initialized yet.</p>
                    <p class="text-sm">Click "Initialize Context Hub" to get started.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Document Viewer/Editor (Right Side) -->
    <div class="lg:col-span-2">
        <div class="bg-white rounded-lg shadow h-full flex flex-col">
            <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <i id="doc-icon" class="fas fa-file-alt text-gray-500"></i>
                    <h3 id="doc-title" class="text-lg font-medium text-gray-900">Select a Document</h3>
                </div>
                <div id="doc-actions" class="hidden flex space-x-2">
                    <button onclick="saveDocument()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors text-sm">
                        <i class="fas fa-save mr-2"></i>
                        Save
                    </button>
                </div>
            </div>
            <div class="p-6 flex-1 overflow-hidden">
                <div id="doc-placeholder" class="text-center py-16 text-gray-500">
                    <i class="fas fa-file-alt text-6xl mb-4"></i>
                    <p class="text-lg">Select a document to view or edit</p>
                    <p class="text-sm mt-2">Click on any file in the tree to open it</p>
                </div>
                <textarea 
                    id="doc-editor" 
                    class="hidden w-full h-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent font-mono text-sm resize-none"
                    placeholder="Document content...">
                </textarea>
            </div>
        </div>
    </div>
</div>

<!-- Create Document Modal -->
<div id="create-doc-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">Create New Document</h3>
            </div>
            <div class="p-6">
                <form id="create-doc-form">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Document Name</label>
                        <input type="text" id="doc-name" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Enter document name..." required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Folder</label>
                        <select id="doc-folder" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Root Folder</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Content</label>
                        <textarea id="doc-content" rows="10" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Enter document content..."></textarea>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeCreateDocumentModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Create Document</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Create Folder Modal -->
<div id="create-folder-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">Create New Folder</h3>
            </div>
            <div class="p-6">
                <form id="create-folder-form">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Folder Name</label>
                        <input type="text" id="folder-name" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Enter folder name..." required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Parent Folder</label>
                        <select id="folder-parent" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Root Level</option>
                        </select>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeCreateFolderModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Create Folder</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Upload Modal -->
<div id="upload-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">Upload File</h3>
            </div>
            <div class="p-6">
                <div class="text-center py-8">
                    <i class="fas fa-upload text-4xl text-gray-400 mb-4"></i>
                    <p class="text-gray-600 mb-4">File upload functionality coming soon!</p>
                    <p class="text-sm text-gray-500">For now, you can create documents manually using the "Create Document" feature.</p>
                </div>
                <div class="flex justify-end">
                    <button onclick="closeUploadModal()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">Close</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- jQuery (required for JSTree) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<!-- JSTree JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.16/jstree.min.js"></script>
<script>
    // Context hub functionality
    let contextData = {
        status: null,
        folders: null,
        selectedDocument: null,
        editorMode: false
    };

    async function loadContextStatus() {
        try {
            const response = await fetch('/api/context/status');
            if (response.ok) {
                const data = await response.json();
                contextData.status = data;
                updateStatusDisplay(data);
            } else {
                updateStatusDisplay({ initialized: false });
            }
        } catch (error) {
            console.error('Failed to load context status:', error);
            updateStatusDisplay({ initialized: false });
        }
    }

    function updateStatusDisplay(status) {
        const statusEl = document.getElementById('context-status');
        const initBtn = document.getElementById('init-context-btn');
        const noContextEl = document.getElementById('no-context');

        if (status.initialized) {
            statusEl.innerHTML = '<i class="fas fa-check-circle mr-1"></i> Ready';
            statusEl.className = 'px-2 py-1 text-xs rounded-full bg-green-100 text-green-800';
            initBtn.classList.add('hidden');
            if (noContextEl) noContextEl.classList.add('hidden');
            loadFolders();
        } else {
            statusEl.innerHTML = '<i class="fas fa-exclamation-circle mr-1"></i> Not Ready';
            statusEl.className = 'px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800';
            initBtn.classList.remove('hidden');
            if (noContextEl) noContextEl.classList.remove('hidden');
        }
    }

    async function initializeContext() {
        try {
            const response = await fetch('/api/context/initialize', { method: 'POST' });
            if (response.ok) {
                // Silent success, just reload
                loadContextStatus();
            } else {
                console.error('Failed to initialize context hub');
            }
        } catch (error) {
            console.error('Error initializing context:', error);
        }
    }

    async function loadFolders() {
        try {
            const response = await fetch('/api/context/folders');
            if (response.ok) {
                const data = await response.json();
                contextData.folders = data;
                updateFolderDisplay(data);
            }
        } catch (error) {
            console.error('Failed to load folders:', error);
        }
    }

    function buildJSTreeData(folders) {
        if (!folders || !folders.tree) {
            return [];
        }
        
        function convertFolderToJSTreeNode(folder) {
            // Create action buttons for folders
            const folderActions = `
                <span class="tree-actions" style="float: right; margin-right: 10px;">
                    <i class="fas fa-plus text-green-500 hover:text-green-700 cursor-pointer mr-2" 
                       onclick="event.stopPropagation(); showQuickCreateModal('${folder.id}', '${folder.name.replace(/'/g, "\\'")}')" 
                       title="Add to folder"></i>
                    <i class="fas fa-trash text-red-500 hover:text-red-700 cursor-pointer" 
                       onclick="event.stopPropagation(); deleteItem('${folder.id}', 'folder', '${folder.name.replace(/'/g, "\\'")}')" 
                       title="Delete folder"></i>
                </span>
            `;
            
            const node = {
                id: folder.id,
                text: `${folder.name} (${folder.document_count || 0} documents)${folderActions}`,
                icon: folder.id === 'root' ? 'fas fa-home' : 'fas fa-folder',
                state: { opened: true },
                data: folder,
                children: []
            };
            
            // Add documents as child nodes
            if (folder.documents && folder.documents.length > 0) {
                folder.documents.forEach(doc => {
                    // Create action buttons for documents
                    const docActions = `
                        <span class="tree-actions" style="float: right; margin-right: 10px;">
                            <i class="fas fa-trash text-red-500 hover:text-red-700 cursor-pointer" 
                               onclick="event.stopPropagation(); deleteItem('${doc.id}', 'document', '${doc.name.replace(/'/g, "\\'")}')" 
                               title="Delete document"></i>
                        </span>
                    `;
                    
                    node.children.push({
                        id: `doc_${doc.id}`,
                        text: doc.name + docActions,
                        icon: 'fas fa-file-alt',
                        type: 'document',
                        data: doc
                    });
                });
            }
            
            // Add subfolders recursively
            if (folder.subfolders && folder.subfolders.length > 0) {
                folder.subfolders.forEach(subfolder => {
                    node.children.push(convertFolderToJSTreeNode(subfolder));
                });
            }
            
            return node;
        }
        
        return folders.tree.map(convertFolderToJSTreeNode);
    }
    
    function updateFolderDisplay(folders) {
        const browserEl = document.getElementById('folder-browser');
        
        if (!folders || !folders.folders) {
            browserEl.innerHTML = '<p class="text-gray-500">No folders found</p>';
            return;
        }
        
        // Destroy existing JSTree if it exists
        if ($.jstree && $('#folder-browser').jstree(true)) {
            $('#folder-browser').jstree('destroy');
        }
        
        const treeData = buildJSTreeData(folders);
        
        // Initialize JSTree
        $('#folder-browser').jstree({
            'core': {
                'data': treeData,
                'check_callback': true,
                'themes': {
                    'name': 'default',
                    'responsive': true
                }
            },
            'plugins': ['wholerow', 'types'],
            'types': {
                'default': {
                    'icon': 'fas fa-folder'
                },
                'document': {
                    'icon': 'fas fa-file-alt'
                }
            }
        }).on('select_node.jstree', function (e, data) {
            // Handle folder or document selection
            if (data.node.type === 'document') {
                // Document selected - load it for viewing/editing
                loadDocument(data.node.data);
            } else {
                // Folder selected - store for creating subfolders and show index guide
                contextData.selectedFolder = data.node.data;
                console.log('Selected folder:', contextData.selectedFolder);
                displayFolderGuide(data.node.data);
            }
        }).on('ready.jstree', function() {
            // Tree is ready
            console.log('JSTree initialized successfully');
        });
    }
    
    async function displayFolderGuide(folder) {
        console.log('Displaying folder guide:', folder);
        
        // Clear selected document
        contextData.selectedDocument = null;
        
        // Update display to show folder guide
        const title = folder.name || 'Folder';
        
        window.document.getElementById('doc-icon').className = 'fas fa-folder text-gray-500';
        window.document.getElementById('doc-title').textContent = title + ' - Folder Guide';
        
        // Fetch the Index Guide content
        let guide = '';
        if (folder.id) {
            try {
                const response = await fetch(`/api/context/folders/${folder.id}/guide`);
                if (response.ok) {
                    const data = await response.json();
                    guide = data.content || '';
                }
            } catch (error) {
                console.error('Error fetching folder guide:', error);
            }
        }
        
        if (guide) {
            // Display the guide content as read-only
            window.document.getElementById('doc-editor').value = guide;
            window.document.getElementById('doc-editor').readOnly = true;
            window.document.getElementById('doc-editor').classList.add('bg-gray-50');
            
            // Show editor, hide placeholder and actions
            window.document.getElementById('doc-placeholder').classList.add('hidden');
            window.document.getElementById('doc-editor').classList.remove('hidden');
            window.document.getElementById('doc-actions').classList.add('hidden');
        } else {
            // No guide - show placeholder with folder info
            const placeholder = window.document.getElementById('doc-placeholder');
            placeholder.innerHTML = `
                <i class="fas fa-folder text-6xl mb-4"></i>
                <p class="text-lg font-medium">${title}</p>
                <p class="text-sm mt-2">This folder has no Index Guide yet.</p>
                <p class="text-sm mt-1">Index Guides help organize content within folders.</p>
                <button onclick="createIndexGuide('${folder.id}', '${title.replace(/'/g, "\\'")}')" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    <i class="fas fa-plus mr-2"></i>Create Index Guide
                </button>
            `;
            placeholder.classList.remove('hidden');
            window.document.getElementById('doc-editor').classList.add('hidden');
            window.document.getElementById('doc-actions').classList.add('hidden');
        }
    }
    
    async function loadDocument(document) {
        console.log('Loading document:', document);
        
        try {
            // Fetch the full document content
            const response = await fetch(`/api/context/documents/${document.id}`);
            if (!response.ok) {
                throw new Error('Failed to load document');
            }
            
            const docData = await response.json();
            contextData.selectedDocument = docData;
            
            // Update document display
            window.document.getElementById('doc-icon').className = 'fas fa-file-alt text-gray-500';
            window.document.getElementById('doc-title').textContent = docData.name;
            window.document.getElementById('doc-editor').value = docData.content || '';
            window.document.getElementById('doc-editor').readOnly = false;
            window.document.getElementById('doc-editor').classList.remove('bg-gray-50');
            
            // Show editor, hide placeholder
            window.document.getElementById('doc-placeholder').classList.add('hidden');
            window.document.getElementById('doc-editor').classList.remove('hidden');
            window.document.getElementById('doc-actions').classList.remove('hidden');
            
        } catch (error) {
            console.error('Error loading document:', error);
            // Show error in placeholder instead of alert
            window.document.getElementById('doc-placeholder').innerHTML = `
                <i class="fas fa-exclamation-circle text-6xl mb-4 text-red-500"></i>
                <p class="text-lg">Failed to load document</p>
                <p class="text-sm mt-2">${error.message}</p>
            `;
            window.document.getElementById('doc-placeholder').classList.remove('hidden');
            window.document.getElementById('doc-editor').classList.add('hidden');
            window.document.getElementById('doc-actions').classList.add('hidden');
        }
    }
    
    async function saveDocument() {
        if (!contextData.selectedDocument) {
            alert('No document selected');
            return;
        }
        
        const content = document.getElementById('doc-editor').value;
        
        try {
            const response = await fetch(`/api/context/documents/${contextData.selectedDocument.id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: contextData.selectedDocument.name,
                    content: content
                })
            });
            
            if (response.ok) {
                // Update local document data
                contextData.selectedDocument.content = content;
                
                // Show success feedback
                const saveBtn = document.querySelector('button[onclick="saveDocument()"]');
                const originalText = saveBtn.innerHTML;
                saveBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Saved';
                saveBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                saveBtn.classList.add('bg-green-700');
                
                setTimeout(() => {
                    saveBtn.innerHTML = originalText;
                    saveBtn.classList.remove('bg-green-700');
                    saveBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                }, 2000);
                
                // Refresh folder data to update any counts
                loadFolders();
            } else {
                console.error('Failed to save document');
                // Visual feedback only - change save button color briefly
                const saveBtn = document.querySelector('button[onclick="saveDocument()"]');
                saveBtn.classList.add('bg-red-600');
                setTimeout(() => {
                    saveBtn.classList.remove('bg-red-600');
                }, 2000);
            }
        } catch (error) {
            console.error('Error saving document:', error);
        }
    }


    async function searchContext() {
        const query = document.getElementById('search-input').value.trim();
        if (!query) return;

        try {
            const response = await fetch(`/api/context/search?q=${encodeURIComponent(query)}&limit=10`);
            if (response.ok) {
                const data = await response.json();
                displaySearchResults(data);
            } else {
                console.error('Search failed');
            }
        } catch (error) {
            console.error('Search error:', error);
        }
    }

    function displaySearchResults(results) {
        const resultsEl = document.getElementById('search-results');
        const listEl = document.getElementById('search-results-list');
        
        listEl.innerHTML = '';
        
        if (!results.results || results.results.length === 0) {
            listEl.innerHTML = '<p class="text-gray-500">No results found</p>';
        } else {
            results.results.forEach(result => {
                const resultEl = document.createElement('div');
                resultEl.className = 'border border-gray-200 rounded-lg p-3';
                resultEl.innerHTML = `
                    <div class="font-medium text-gray-900">${result.name}</div>
                    <div class="text-sm text-gray-600 mt-1">${result.content ? result.content.substring(0, 200) + '...' : 'No content preview'}</div>
                `;
                listEl.appendChild(resultEl);
            });
        }
        
        resultsEl.classList.remove('hidden');
    }

    function handleSearchKeypress(event) {
        if (event.key === 'Enter') {
            searchContext();
        }
    }

    async function refreshContext() {
        // Show loading state on refresh button
        const refreshBtn = document.getElementById('refresh-btn');
        const originalHTML = refreshBtn.innerHTML;
        refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        refreshBtn.disabled = true;
        
        try {
            // Refresh all components
            await loadContextStatus();
            await loadFolders();
            
            // If a document is currently selected, reload it by fetching fresh data
            if (contextData.selectedDocument && contextData.selectedDocument.id) {
                // Re-fetch the document to get latest content
                await loadDocument({id: contextData.selectedDocument.id, name: contextData.selectedDocument.name});
            }
        } finally {
            // Restore button state
            refreshBtn.innerHTML = originalHTML;
            refreshBtn.disabled = false;
        }
    }

    function showCreateDocumentModal() {
        document.getElementById('create-doc-modal').classList.remove('hidden');
        populateFolderSelect();
    }

    function closeCreateDocumentModal() {
        document.getElementById('create-doc-modal').classList.add('hidden');
        document.getElementById('create-doc-form').reset();
    }

    function populateFolderSelect() {
        const select = document.getElementById('doc-folder');
        select.innerHTML = '<option value="">Root Folder</option>';
        
        if (contextData.folders && contextData.folders.folders) {
            contextData.folders.folders.forEach(folder => {
                const option = document.createElement('option');
                option.value = folder.id;
                option.textContent = folder.name;
                select.appendChild(option);
            });
        }
    }

    function showUploadModal() {
        document.getElementById('upload-modal').classList.remove('hidden');
    }

    function closeUploadModal() {
        document.getElementById('upload-modal').classList.add('hidden');
    }

    function exportContext() {
        // Silent - no alert for unimplemented features
        console.log('Export functionality not yet implemented');
    }

    // Handle create document form submission
    document.getElementById('create-doc-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const name = document.getElementById('doc-name').value;
        const content = document.getElementById('doc-content').value;
        const folderId = document.getElementById('doc-folder').value || null;
        
        if (!name.trim()) {
            alert('Please enter a document name');
            return;
        }
        
        try {
            const response = await fetch('/api/context/documents', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: name,
                    content: content,
                    folder_id: folderId
                })
            });
            
            if (response.ok) {
                closeCreateDocumentModal();
                loadFolders();
                // Silent success
            } else {
                console.error('Failed to create document');
            }
        } catch (error) {
            console.error('Error creating document:', error);
        }
    });

    function showCreateFolderModal() {
        document.getElementById('create-folder-modal').classList.remove('hidden');
        populateFolderParentSelect();
    }

    function closeCreateFolderModal() {
        document.getElementById('create-folder-modal').classList.add('hidden');
        document.getElementById('create-folder-form').reset();
    }

    function populateFolderParentSelect() {
        const select = document.getElementById('folder-parent');
        select.innerHTML = '<option value="">Root Level</option>';
        
        if (contextData.folders && contextData.folders.folders) {
            contextData.folders.folders.forEach(folder => {
                if (folder.id !== 'root') {
                    const option = document.createElement('option');
                    option.value = folder.id;
                    const indentPrefix = '  '.repeat(folder.level || 0);
                    option.textContent = indentPrefix + folder.name;
                    select.appendChild(option);
                }
            });
        }
        
        // Pre-select the currently selected folder as the parent
        if (contextData.selectedFolder && contextData.selectedFolder.id !== 'root') {
            select.value = contextData.selectedFolder.id;
        }
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', () => {
        loadContextStatus();
    });

    // Close modals when clicking outside
    document.getElementById('create-doc-modal').addEventListener('click', (e) => {
        if (e.target.id === 'create-doc-modal') {
            closeCreateDocumentModal();
        }
    });

    document.getElementById('upload-modal').addEventListener('click', (e) => {
        if (e.target.id === 'upload-modal') {
            closeUploadModal();
        }
    });

    document.getElementById('create-folder-modal').addEventListener('click', (e) => {
        if (e.target.id === 'create-folder-modal') {
            closeCreateFolderModal();
        }
    });

    // Handle create folder form submission
    document.getElementById('create-folder-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const name = document.getElementById('folder-name').value;
        const parentId = document.getElementById('folder-parent').value || null;
        
        if (!name.trim()) {
            alert('Please enter a folder name');
            return;
        }
        
        try {
            const response = await fetch('/api/context/folders', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: name,
                    parent_id: parentId
                })
            });
            
            if (response.ok) {
                closeCreateFolderModal();
                loadFolders();
                // Silent success
            } else {
                console.error('Failed to create folder');
            }
        } catch (error) {
            console.error('Error creating folder:', error);
        }
    });

    // Delete item function
    async function deleteItem(itemId, itemType, itemName) {
        // Delete without confirmation
        try {
            const endpoint = itemType === 'folder' ? 
                `/api/context/folders/${itemId}` : 
                `/api/context/documents/${itemId}`;
            
            const response = await fetch(endpoint, { method: 'DELETE' });
            
            if (response.ok) {
                // Silently refresh the folder list
                loadFolders();
            } else {
                // Only show error if deletion fails
                console.error(`Failed to delete ${itemType}: ${response.status}`);
            }
        } catch (error) {
            console.error(`Error deleting ${itemType}:`, error);
        }
    }

    // Quick create modal - default to document
    function showQuickCreateModal(folderId, folderName) {
        // Default to creating a document
        contextData.selectedFolder = { id: folderId, name: folderName };
        showCreateDocumentModal();
        // Pre-select the folder in the modal
        setTimeout(() => {
            const select = document.getElementById('doc-folder');
            if (select) select.value = folderId;
        }, 100);
    }
    
    // Create Index Guide for a folder
    async function createIndexGuide(folderId, folderName) {
        const defaultContent = `# ${folderName} Folder

## Purpose
This folder is for organizing your ${folderName.toLowerCase()} content.

## Organization Guidelines
- Keep related documents together
- Use descriptive names for your files
- Consider creating subfolders for better organization
- Update documents regularly to keep information current

## Best Practices
- Add dates to time-sensitive documents
- Use consistent naming conventions
- Include relevant keywords for easy searching
- Regular review and cleanup of outdated content
`;
        
        try {
            const response = await fetch('/api/context/documents', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: 'Index Guide',
                    content: defaultContent,
                    folder_id: folderId,
                    doc_type: 'IndexGuide'
                })
            });
            
            if (response.ok) {
                // Silent success
                await loadFolders();
                // Re-display the folder with the new guide
                const folder = contextData.folders?.folders?.find(f => f.id === folderId);
                if (folder) {
                    folder.index_guide = defaultContent;
                    displayFolderGuide(folder);
                }
            } else {
                console.error('Failed to create Index Guide');
            }
        } catch (error) {
            console.error('Error creating Index Guide:', error);
        }
    }
</script>
{% endblock %}
